# Exercise 5: Uuden lis√§osan luominen

**Contents:** Lis√§osien luominen k√§ytt√§en Cookiecutteria

**Goal:**  Kurssilainen osaa luoda omia lis√§osiaan

Lis√§osapohja luodaan komentorivity√∂kaluilla. K√§ytet√§√§n komentorivin√§
QGIS-asennukseen kuuluvaa OSGeo4W Shelli√§. Avaa se esimerkiksi hakupalkista
kirjoittamalla OSGeo4W.

![](img/harjoitus_5/image1.png)

## Gitin konfigurointi

Ennen lis√§osan luomista konfiguroidaan [git](https://git-scm.com/)-versionhallintaty√∂kalu toimimaan oikein.

1. Ensin OSGeo4W shelliss√§ polku git.exe:en t√§ytyy lis√§t√§ ensin Path-ymp√§rist√∂muuttujaan:

::: commandline-box
```bash
set Path=%Path%;"C:\Program Files\Git\cmd"
```
:::

2. Aseta gitille k√§ytt√§j√§nimesi ja s√§hk√∂postiosoitteesi

::: commandline-box
```bash
git config --global user.name k√§ytt√§j√§nimesi-gitiss√§
```
:::

::: commandline-box
```bash
git config --global user.email s√§hk√∂postiosoitteesi
```
:::

3. Aseta gitin submoduulien (kuten qgis_plugin_tools) p√§ivitt√§minen tapahtumaan `git pull`:n yhteydess√§

::: commandline-box
```bash
git config --global submodule.recurse true
```
:::

4. Seuraavaksi pakota git asettamaan tiedostojen rivinvaihdot Unix-yhteensopiviksi

::: commandline-box
```bash
git config --global core.autocrlf input
```
:::

## Lis√§osan luominen

Luo ensin sopivaan sijaintiin kansio lis√§osalle ja navigoi kansioon
OSGeo4W Shelliss√§:

![](img/harjoitus_5/image2.gif)

1. Luo oma virtuaaliymp√§rist√∂ cookiecutter-pluginille

::: commandline-box
```bash
%PYTHONHOME%/python.exe -m venv cookiecutter-venv
```
:::

::: note-box
%PYTHONHOME%-ymp√§rist√∂muuttuja OSGeo4W-shelliss√§ viittaa QGIS-asennukseen
kuuluvaan Python-tulkkiin.
:::

2. Aktivoi luomasi virtuaaliymp√§rist√∂ *cookiecutter-venv*

::: commandline-box
```bash
.\cookiecutter-venv\Scripts\activate
```
:::

3. Asenna virtuaaliymp√§rist√∂√∂n kirjastot `cookiecutter` ja `pip-tools`

::: commandline-box
```bash
python -m pip install -U pip
pip install cookiecutter pip-tools
```
:::

4. Luo uusi template:

::: commandline-box
```bash
cookiecutter https://github.com/GispoCoding/cookiecutter-qgis-plugin.git
```
:::

* Voit k√§ytt√§√§ oletusasetuksia **paitsi kohdissa**:
	* `Select a name for your plugin`: Test Plugin
	* `Include processing algorithm in your plugin?`: y

5. Deaktivoi cookiecutteria varten luotu virtuaaliymp√§rist√∂ ja siirry cookiecutterin luomaan lis√§osakansioon:

::: commandline-box
```bash
deactivate
cd test-plugin
```
:::

6. Aja kansiossa oleva valmis Python-skripti, joka luo lis√§osakehitykselle sopivan
virtuaalisen ymp√§rist√∂n:

::: commandline-box
```bash
python create_qgis_venv.py
```
:::

::: hint-box
Jos tietokoneellasi on monta QGIS- asennusta, skripti saattaa kysy√§ mit√§ niist√§ halutaan k√§ytt√§√§ kehityksess√§.
Valitse niist√§ parhaiten sopiva, mielell√§√§n uusin LTR- versio.
:::

7. Aktivoi uusi virtuaaliymp√§rist√∂:

::: commandline-box
```bash
.venv\Scripts\activate
```
:::

8. Asenna virtuaaliymp√§rist√∂√∂n pip:

::: commandline-box
```bash
python -m pip install -U pip
```
:::

9. Asenna pip-tools:

::: commandline-box
```bash
pip install pip-tools
```
:::

10. K√§√§nn√§ pip-compile-ty√∂kalulla tekstitiedostoon listaus
tarvituista Python-paketeista:

::: commandline-box
```bash
pip-compile requirements-dev.in
```
:::

11. √Ñskeisess√§ vaiheessa ty√∂kalu kirjoitti `requirements-dev.txt`-tiedostoon
listan asennettavista Python-paketeista. Asenna ne seuraavaksi:

::: commandline-box
```bash
pip install -r requirements-dev.txt
```
:::

12. Komennon j√§lkeen on hyv√§ tarkistaa, ett√§ asennukset ovat onnistuneet komennolla
`pip freeze`. Pakettien joukossa pit√§isi olla mm. `pytest` ja `pytest-qgis`.

13. T√§ss√§ vaiheessa p√§√§st√§√§n viimein avaamaan Visual Studio Code. Avaa kansiosta
`test-plugin.code-workspace`-tiedosto. Sen pit√§isi avautua automaattisesti VS Codessa.

14. Ensin asetetaan VS Code k√§ytt√§m√§√§n √§sken luotua `.venv`-ymp√§rist√∂√§. Valitaan
**Help**-valikosta **Show All Commands** ja kirjoitetaan hakuun `Python: Select Interpreter`.

![](img/harjoitus_5/image3.png)

15. Kun poistut VS Codesta, avaat sen uudelleen ja avaat `test-plugin`-kansion,
kehitysymp√§rist√∂n pit√§isi olla t√§ysin kunnossa. Voit todeta t√§m√§n avaamalla
`testplugin`-kansion alta tiedoston `plugin.py`. Tiedoston yl√§osan 
importeissa ei pit√§isi n√§ky√§ virheist√§ kertovia korostuksia.

![](img/harjoitus_5/image4.png)

16. Projekti sis√§lt√§√§ my√∂s yhden testin, jonka avulla on hyv√§ tutustua VS Coden
Testing-laajennukseen. Vasemman palkin symbolista avautuu paneeli, jonka kahden
kolmion symbolilla p√§√§see ajamaan kaikki m√§√§ritellyt testit.

![](img/harjoitus_5/image5.png)

Kehitysymp√§rist√∂ on nyt konfiguroitu ja valmiina k√§ytt√∂√§ varten. Hienoa!

## Ensimm√§inen commit
Nyt on aika tehd√§ ensimm√§inen `commit`, eli `git commit`. Avaa uusi komentorivi
VS Coden sis√§ll√§ klikkaamalla *Terminal->New Terminal*. 

> Tarkastele komentorivin sis√§lt√∂√§. Se avautuu oletuksena PowerShellin√§, mutta
my√∂s perinteinen komentorivi kelpaa hyvin. VS Code yritt√§√§ automaattisesti
aktivoida virtuaaliymp√§rist√∂n. PowerShellill√§ t√§m√§ ei v√§ltt√§m√§tt√§ onnistu ja
voit saada virheilmoituksen: `Activate.ps1 cannot be loaded because running
scripts is disabled on this system`, aja seuraava koodinp√§tk√§ ja avaa t√§m√§n
j√§lkeen uusi terminaali-ikkuna: `Set-ExecutionPolicy RemoteSigned -Scope CurrentUser`.

Sitten tehd√§√§n ensimm√§inen commit

1. Lis√§√§ kaikki tiedostot lis√§tt√§v√§ksi committiin kirjoittamalla:

::: commandline-box
```bash
git add -A
```
:::

1. Tarkastele `git status`-komennolla mit√§ kaikkea on nyt lis√§tty lis√§tt√§v√§ksi.
1. Kokeile nyt tehd√§ ensimm√§inen commit komennolla: 

::: commandline-box
```bash
git commit -m "Initial commit"
```
:::

Onneksi olkoon, olet nyt onnistuneesti luonut ensimm√§isen commitin lis√§osaan!

## Lis√§osan k√§ytt√∂√∂notto
Ensimm√§ist√§ lis√§osaa on hyv√§ kokeilla. Avataan siis QGIS ja testataan lis√§osaa.

1. Avaa QGIS ja luo sille uusi profiili `training`
1. Muokkaa VS Codella `testplugin/build.py`-tiedostoa ja muuta: `profile = "training"`
1. Navigoi komentorivill√§ kansioon `testplugin` ja lataa lis√§osa k√§ytt√∂√∂n k√§ytt√§en `build.py deploy` -komentoa.

::: commandline-box
```bash
cd testplugin
python build.py deploy
```
:::

1. K√§ynnist√§ nyt QGIS uudelleen ja varmistu, ett√§ se on profiilissa **training**
1. Avaa Lis√§osien hallintaty√∂kalu ja valitse paneelista *Asennettu* **Test Plugin**
    *  Asenna samalla my√∂s paneelista *Kaikki* lis√§osa **Plugin Reloader**. Tarvitsemme sit√§ aina, kun haluamme ottaa uudet muutokset k√§ytt√∂√∂n k√§ynnist√§m√§tt√§ QGISi√§ uudelleen.
1. Testaa nyt lis√§osan toiminnallisuutta. Avaa ensin QGISin Python-konsoli ja k√§ynnist√§ sitten lis√§osa *Lis√§osat -> TestPlugin -> Test Plugin*. Huomaat, ett√§ konsoliin ilmestyy teksti√§...


## Lis√§osan rakenne
Tutustutaan seuraavaksi lis√§osan rakenteeseen. Alla on hieman yksinkertaistettu kaavio t√§rkeimmist√§ tiedostoista.

```
üì¶test-plugin
 ‚î£ üìÇ.git
 ‚î£ üìÇtestplugin
 | ‚î£ üìÇqgis_plugin_tools
 | ‚î£ üìÇresources
 ‚îÉ ‚î£ üìúmetadata.txt
 ‚îÉ ‚î£ üìúplugin.py
 ‚îÉ ‚îó üìú__init__.py
 ‚î£ üìÇtests
 ‚îÉ ‚î£ üìútest_plugin.py
 ‚î£ üìú.gitignore
 ‚î£ üìúLICENSE
 ‚î£ üìúREADME.md
 ‚î£ üìúrequirements-dev.txt
 ‚îó üìúpyproject.toml
```


### Tiedosto: plugin.py
Tutustu ensin tiedostoon `testplugin/plugin.py` ja sen sis√§ll√§ olevaan luokkaan
`Plugin`. Siin√§ pit√§isi olla ainakin seuraavat metodit:

>* `__init__`: luokan konstruktori, sit√§ kutsutaan `testplugin/__init__.py`-tiedostosta.
>* `initGui`: lis√§√§ lis√§osan QGISin GUIhin, eli graafiseen k√§ytt√∂liittym√§√§n
>* `unload`: poistaa lis√§osan QGISin GUIsta
>* `run`: koodi, jota suoritetaan, kun k√§ytt√§j√§ k√§ynnist√§√§ lis√§osan


Metodin `run` nime√§ voi muuttaa, mutta muiden nimet pit√§√§ olla t√§sm√§lleen samat,
sill√§ QGIS kutsuu niit√§ sis√§isesti.

### Tiedosto: \_\_init\_\_.py
T√§m√§ tiedosto sis√§lt√§√§ t√§rke√§n metodin `classFactory`. QGIS alustaa lis√§osan kutsumalla t√§t√§ metodia. Se taas puolestaan palauttaa QGISille koko lis√§osan yll√§ mainitun `Plugin`-luokan. 

::: code-box
```python
def classFactory(iface: QgisInterface):
    from testplugin.plugin import Plugin

    return Plugin()
```
:::

